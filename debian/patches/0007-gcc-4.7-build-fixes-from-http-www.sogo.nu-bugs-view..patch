From: Jeroen Dekkers <jeroen@dekkers.ch>
Date: Wed, 9 May 2012 13:09:47 +0200
Subject: gcc 4.7 build fixes from http://www.sogo.nu/bugs/view.php?id=1763

---
 .../NGObjWeb/Associations/WOKeyPathAssociation.m   |    4 ++--
 .../NGObjWeb/DynamicElements/WOComponentContent.m  |    6 +++---
 .../DynamicElements/WOComponentReference.m         |    2 +-
 .../NGObjWeb/DynamicElements/WOCompoundElement.m   |    2 +-
 sope-appserver/NGObjWeb/NSObject+WO.m              |    6 +++---
 sope-appserver/NGObjWeb/SoObjects/SoObjCClass.m    |    2 +-
 .../NGObjWeb/SoObjects/SoSelectorInvocation.m      |    2 +-
 sope-appserver/NGObjWeb/WOApplication.m            |    2 +-
 sope-appserver/NGObjWeb/WOComponent+Sync.m         |    2 +-
 .../NGObjWeb/WODirectActionRequestHandler.m        |    2 +-
 sope-appserver/NGObjWeb/WOSession.m                |    2 +-
 sope-appserver/NGObjWeb/common.h                   |    2 +-
 sope-core/EOControl/EOKeyValueCoding.m             |    2 +-
 sope-core/EOControl/EOValidation.m                 |    2 +-
 sope-core/EOControl/common.h                       |    6 ++++++
 .../EOExt.subproj/EOQualifier+CtxEval.m            |    2 +-
 sope-core/NGExtensions/FdExt.subproj/NSNull+misc.m |    2 +-
 sope-core/NGExtensions/NGBundleManager.m           |    2 +-
 .../NGExtensions/NGExtensions/NGMemoryAllocation.h |    2 +-
 sope-core/NGExtensions/common.h                    |    2 +-
 sope-core/NGStreams/common.h                       |    2 +-
 sope-gdl1/GDLAccess/EODatabaseFault.m              |    8 ++++----
 sope-gdl1/GDLAccess/EOFault.m                      |    6 +++---
 sope-gdl1/GDLAccess/EOFaultHandler.m               |   11 +++++++----
 sope-gdl1/GDLAccess/EOKeyComparisonQualifier+SQL.m |    6 ------
 sope-gdl1/GDLAccess/EORecordDictionary.m           |    2 +-
 sope-gdl1/GDLAccess/common.h                       |   10 ++++++++++
 sope-ldap/NGLdap/EOQualifier+LDAP.m                |    4 ++++
 sope-mime/NGImap4/imCommon.h                       |    6 ++++++
 29 files changed, 66 insertions(+), 43 deletions(-)

diff --git a/sope-appserver/NGObjWeb/Associations/WOKeyPathAssociation.m b/sope-appserver/NGObjWeb/Associations/WOKeyPathAssociation.m
index 21a983b..13a33ee 100644
--- a/sope-appserver/NGObjWeb/Associations/WOKeyPathAssociation.m
+++ b/sope-appserver/NGObjWeb/Associations/WOKeyPathAssociation.m
@@ -25,7 +25,7 @@
 #include "common.h"
 #include <string.h>
 
-#if __GNU_LIBOBJC__ == 20100911
+#if __GNU_LIBOBJC__ >= 20100911
 #define METHOD_NULL NULL
 #define object_is_instance(XXX) (XXX != nil)
 #define class_get_class_method    class_getClassMethod
@@ -479,7 +479,7 @@ static inline void _fillInfo(WOKeyPathAssociation *self, id object,
     
     if (method != METHOD_NULL) {
       info->access.method = method_get_imp(method);
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
       info->retType = *(method_getTypeEncoding(method));
 #else
 	  info->retType = *(method->method_types);
diff --git a/sope-appserver/NGObjWeb/DynamicElements/WOComponentContent.m b/sope-appserver/NGObjWeb/DynamicElements/WOComponentContent.m
index b344f17..baa198e 100644
--- a/sope-appserver/NGObjWeb/DynamicElements/WOComponentContent.m
+++ b/sope-appserver/NGObjWeb/DynamicElements/WOComponentContent.m
@@ -75,7 +75,7 @@ static Class NSDateClass = Nil;
         printf("  ");
       printf("content: [%s %s]: %0.3fs\n",
              [[component name] cString], 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 	     sel_getName(_cmd), 
 #else
 	     sel_get_name(_cmd), 
@@ -115,7 +115,7 @@ static Class NSDateClass = Nil;
         printf("  ");
       printf("content: [%s %s]: %0.3fs\n",
              [[component name] cString], 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 	     sel_getName(_cmd), 
 #else
 	     sel_get_name(_cmd), 
@@ -165,7 +165,7 @@ static Class NSDateClass = Nil;
         printf("  ");
       printf("content: [%s %s]: %0.3fs\n",
              [[component name] cString], 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 	     sel_getName(_cmd), 
 #else
 	     sel_get_name(_cmd), 
diff --git a/sope-appserver/NGObjWeb/DynamicElements/WOComponentReference.m b/sope-appserver/NGObjWeb/DynamicElements/WOComponentReference.m
index 5b9b239..9c82734 100644
--- a/sope-appserver/NGObjWeb/DynamicElements/WOComponentReference.m
+++ b/sope-appserver/NGObjWeb/DynamicElements/WOComponentReference.m
@@ -179,7 +179,7 @@ _updateComponent(WOComponentReference *self, WOContext *_ctx)
         printf("  ");
       printf("[%s %s]: %0.3fs\n",
              [[child name] cString], 
-#if APPLE_RUNTIME || NeXT_RUNTIME
+#if APPLE_RUNTIME || NeXT_RUNTIME || (__GNU_LIBOBJC__ >= 20100911)
 	     sel_getName(_cmd), 
 #else
 	     sel_get_name(_cmd), 
diff --git a/sope-appserver/NGObjWeb/DynamicElements/WOCompoundElement.m b/sope-appserver/NGObjWeb/DynamicElements/WOCompoundElement.m
index 389bea4..65ed24d 100644
--- a/sope-appserver/NGObjWeb/DynamicElements/WOCompoundElement.m
+++ b/sope-appserver/NGObjWeb/DynamicElements/WOCompoundElement.m
@@ -262,7 +262,7 @@ static int descriptiveIDs = -1;
             printf("  ");
 #endif
           printf("  Child of 0x%p: i[%i] %s <%s>: %0.3fs\n",
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 				 self, i, [[_ctx elementID] cString], class_getName([child class]),
 #else
                  self, i, [[_ctx elementID] cString], [child class]->name,
diff --git a/sope-appserver/NGObjWeb/NSObject+WO.m b/sope-appserver/NGObjWeb/NSObject+WO.m
index 458d0c6..2c9c949 100644
--- a/sope-appserver/NGObjWeb/NSObject+WO.m
+++ b/sope-appserver/NGObjWeb/NSObject+WO.m
@@ -131,7 +131,7 @@ static inline SEL _getSetSel(register const unsigned char *_key,
                              register unsigned _len) {
   char buf[259];
   _getSetSelName((unsigned char *)buf, _key, _len);
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
   return sel_getUid(buf);
 #else
   return sel_get_uid(buf);
@@ -259,7 +259,7 @@ IMP WOGetKVCGetMethod(id object, NSString *_key) {
   if (object == nil) return NULL;
   if (_key   == nil) return NULL;
 
-#if GNU_RUNTIME && !(defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911))
+#if GNU_RUNTIME && !(defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911))
   {
     unsigned keyLen;
     char     *buf;
@@ -308,7 +308,7 @@ id WOGetKVCValueUsingMethod(id object, NSString *_key) {
     char *buf;
     buf = malloc(keyLen + 1);
     [_key getCString:buf];
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
     getSel = sel_getUid(buf);
 #else
     getSel = sel_get_uid(buf);
diff --git a/sope-appserver/NGObjWeb/SoObjects/SoObjCClass.m b/sope-appserver/NGObjWeb/SoObjects/SoObjCClass.m
index b8cd143..e3f9f9c 100644
--- a/sope-appserver/NGObjWeb/SoObjects/SoObjCClass.m
+++ b/sope-appserver/NGObjWeb/SoObjects/SoObjCClass.m
@@ -43,7 +43,7 @@
 
   a = [NSMutableArray array];
 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
   Method *p, *m;
   int count;
    
diff --git a/sope-appserver/NGObjWeb/SoObjects/SoSelectorInvocation.m b/sope-appserver/NGObjWeb/SoObjects/SoSelectorInvocation.m
index b8b4812..a453fab 100644
--- a/sope-appserver/NGObjWeb/SoObjects/SoSelectorInvocation.m
+++ b/sope-appserver/NGObjWeb/SoObjects/SoSelectorInvocation.m
@@ -28,7 +28,7 @@
 #include <DOM/EDOM.h>
 #include "common.h"
 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 #  define sel_get_any_uid   sel_getUid
 #  define sel_register_name sel_registerName
 #endif
diff --git a/sope-appserver/NGObjWeb/WOApplication.m b/sope-appserver/NGObjWeb/WOApplication.m
index 93978bb..a7ece1a 100644
--- a/sope-appserver/NGObjWeb/WOApplication.m
+++ b/sope-appserver/NGObjWeb/WOApplication.m
@@ -38,7 +38,7 @@
 #include "common.h"
 #include <time.h>
 
-#if GNU_RUNTIME && !defined(__GNUSTEP_RUNTIME__)
+#if GNU_RUNTIME && !defined(__GNUSTEP_RUNTIME__) && !(__GNU_LIBOBJC__ >= 20110608)
 #  include <objc/sarray.h>
 #endif
 
diff --git a/sope-appserver/NGObjWeb/WOComponent+Sync.m b/sope-appserver/NGObjWeb/WOComponent+Sync.m
index ffbb6be..3e9abf6 100644
--- a/sope-appserver/NGObjWeb/WOComponent+Sync.m
+++ b/sope-appserver/NGObjWeb/WOComponent+Sync.m
@@ -23,7 +23,7 @@
 #include <NGObjWeb/WOAssociation.h>
 #include "common.h"
 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 #  include <objc/objc.h>
 #  define class_get_instance_method class_getInstanceMethod
 #  define method_get_imp method_getImplementation
diff --git a/sope-appserver/NGObjWeb/WODirectActionRequestHandler.m b/sope-appserver/NGObjWeb/WODirectActionRequestHandler.m
index 63d32d7..b7b13c7 100644
--- a/sope-appserver/NGObjWeb/WODirectActionRequestHandler.m
+++ b/sope-appserver/NGObjWeb/WODirectActionRequestHandler.m
@@ -70,7 +70,7 @@ static Class NSDateClass = Nil;
 - (BOOL)isComponentClass:(Class)_clazz {
   if (_clazz == Nil) 
     return NO;
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
   while ((_clazz = class_getSuperclass(_clazz)) != Nil) {
 #else
   while ((_clazz = _clazz->super_class) != Nil) {
diff --git a/sope-appserver/NGObjWeb/WOSession.m b/sope-appserver/NGObjWeb/WOSession.m
index b525d73..3a99b85 100644
--- a/sope-appserver/NGObjWeb/WOSession.m
+++ b/sope-appserver/NGObjWeb/WOSession.m
@@ -33,7 +33,7 @@
 #include "common.h"
 #include <string.h>
 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 #  define sel_get_name sel_getName
 #endif
 
diff --git a/sope-appserver/NGObjWeb/common.h b/sope-appserver/NGObjWeb/common.h
index 68bc9c1..ab48ab8 100644
--- a/sope-appserver/NGObjWeb/common.h
+++ b/sope-appserver/NGObjWeb/common.h
@@ -51,7 +51,7 @@
 #include <NGExtensions/NGLogging.h>
 #include <NGStreams/NGStreams.h>
 
-#if NeXT_RUNTIME || APPLE_RUNTIME
+#if NeXT_RUNTIME || APPLE_RUNTIME || (__GNU_LIBOBJC__ >= 20100911)
 #  ifndef sel_get_name
 #    define sel_get_name(__XXX__)    sel_getName(__XXX__)
 #    define sel_get_any_uid(__XXX__) sel_getUid(__XXX__)
diff --git a/sope-core/EOControl/EOKeyValueCoding.m b/sope-core/EOControl/EOKeyValueCoding.m
index 5971cd9..c669203 100644
--- a/sope-core/EOControl/EOKeyValueCoding.m
+++ b/sope-core/EOControl/EOKeyValueCoding.m
@@ -25,7 +25,7 @@
 
 #if GNU_RUNTIME
 
-#if __GNU_LIBOBJC__ == 20100911
+#if __GNU_LIBOBJC__ >= 20100911
 #  define sel_get_any_uid sel_getUid
 #  include <objc/runtime.h>
 #else
diff --git a/sope-core/EOControl/EOValidation.m b/sope-core/EOControl/EOValidation.m
index 12bc47b..21261c7 100644
--- a/sope-core/EOControl/EOValidation.m
+++ b/sope-core/EOControl/EOValidation.m
@@ -24,7 +24,7 @@
 #include "EONull.h"
 #include "common.h"
 
-#if __GNU_LIBOBJC__ == 20100911
+#if __GNU_LIBOBJC__ >= 20100911
 #  define sel_get_any_uid sel_getUid
 #endif
 
diff --git a/sope-core/EOControl/common.h b/sope-core/EOControl/common.h
index 0339881..16323ef 100644
--- a/sope-core/EOControl/common.h
+++ b/sope-core/EOControl/common.h
@@ -39,6 +39,12 @@
 #  endif
 #endif
 
+#if __GNU_LIBOBJC__ >= 20100911
+#  ifndef sel_eq
+#    define sel_eq(__A__,__B__) sel_isEqual(__A__,__B__)
+#  endif
+#endif
+
 #ifndef ASSIGN
 #  define ASSIGN(object, value) \
        ({id __object = (id)object;    \
diff --git a/sope-core/NGExtensions/EOExt.subproj/EOQualifier+CtxEval.m b/sope-core/NGExtensions/EOExt.subproj/EOQualifier+CtxEval.m
index f1c9cbb..4df41b5 100644
--- a/sope-core/NGExtensions/EOExt.subproj/EOQualifier+CtxEval.m
+++ b/sope-core/NGExtensions/EOExt.subproj/EOQualifier+CtxEval.m
@@ -29,7 +29,7 @@
 #  import <objc/objc.h>
 #  import <extensions/objc-runtime.h>
 #elif GNUSTEP_BASE_LIBRARY
-#if __GNU_LIBOBJC__ == 20100911
+#if __GNU_LIBOBJC__ >= 20100911
 #  define sel_get_name sel_getName
 #  import <objc/runtime.h>
 #else
diff --git a/sope-core/NGExtensions/FdExt.subproj/NSNull+misc.m b/sope-core/NGExtensions/FdExt.subproj/NSNull+misc.m
index 5993b5d..495faf5 100644
--- a/sope-core/NGExtensions/FdExt.subproj/NSNull+misc.m
+++ b/sope-core/NGExtensions/FdExt.subproj/NSNull+misc.m
@@ -23,7 +23,7 @@
 #include "common.h"
 
 #if LIB_FOUNDATION_LIBRARY || GNUSTEP_BASE_LIBRARY
-#if __GNU_LIBOBJC__ == 20100911
+#if __GNU_LIBOBJC__ >= 20100911
 #  include <objc/runtime.h>
 #else
 #  include <objc/objc-api.h>
diff --git a/sope-core/NGExtensions/NGBundleManager.m b/sope-core/NGExtensions/NGBundleManager.m
index 1c7b62a..1a55e74 100644
--- a/sope-core/NGExtensions/NGBundleManager.m
+++ b/sope-core/NGExtensions/NGBundleManager.m
@@ -2005,7 +2005,7 @@ static BOOL debugLanguageLookup = NO;
   
   sprintf (buffer,
 	   "<%s %p fullPath: %s infoDictionary: %p loaded=%s>",
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) 
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) 
 	   (char*)class_getName([self class]),
 #else
 	   (char*)object_get_class_name(self),
diff --git a/sope-core/NGExtensions/NGExtensions/NGMemoryAllocation.h b/sope-core/NGExtensions/NGExtensions/NGMemoryAllocation.h
index d594d39..bba38af 100644
--- a/sope-core/NGExtensions/NGExtensions/NGMemoryAllocation.h
+++ b/sope-core/NGExtensions/NGExtensions/NGMemoryAllocation.h
@@ -22,7 +22,7 @@
 #ifndef __NGExtensions_NGMemoryAllocation_H__
 #define __NGExtensions_NGMemoryAllocation_H__
 
-#if __GNU_LIBOBJC__ != 20100911
+#if !(__GNU_LIBOBJC__ >= 20100911)
 #include <objc/objc-api.h>
 #endif
 
diff --git a/sope-core/NGExtensions/common.h b/sope-core/NGExtensions/common.h
index 4ce9ab0..6dea4ea 100644
--- a/sope-core/NGExtensions/common.h
+++ b/sope-core/NGExtensions/common.h
@@ -41,7 +41,7 @@
 #endif
 
 #if GNU_RUNTIME
-#if __GNU_LIBOBJC__ == 20100911
+#if __GNU_LIBOBJC__ >= 20100911
 #  include <objc/runtime.h>
 #else
 #  import <objc/objc-api.h>
diff --git a/sope-core/NGStreams/common.h b/sope-core/NGStreams/common.h
index 85076d7..2d35296 100644
--- a/sope-core/NGStreams/common.h
+++ b/sope-core/NGStreams/common.h
@@ -40,7 +40,7 @@
 #endif
 
 #ifdef GNU_RUNTIME
-#if __GNU_LIBOBJC__ == 20100911
+#if __GNU_LIBOBJC__ >= 20100911
 #  include <objc/runtime.h>
 #else
 #  include <objc/objc-api.h>
diff --git a/sope-gdl1/GDLAccess/EODatabaseFault.m b/sope-gdl1/GDLAccess/EODatabaseFault.m
index 71331bc..cab651b 100644
--- a/sope-gdl1/GDLAccess/EODatabaseFault.m
+++ b/sope-gdl1/GDLAccess/EODatabaseFault.m
@@ -66,7 +66,7 @@ typedef struct {
     
     if (fault == nil)
         return nil;
-#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) 
+#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) || (__GNU_LIBOBJC__ >= 20100911)
     if (class_getInstanceSize([fault class]) < class_getInstanceSize([self class])) {
 #else
 	if ([fault class]->instance_size < ((Class)self)->instance_size) {
@@ -77,7 +77,7 @@ typedef struct {
 		       @"Instances from class %@ must be at least %d in size "
 		       @"to fault",
 		       NSStringFromClass([fault class]),
-#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) || (__GNU_LIBOBJC__ >= 20100911)
 		       class_getInstanceSize([self class])];
 #else
 			   ((Class)self)->instance_size];
@@ -132,7 +132,7 @@ typedef struct {
     
   fault = [NSMutableArray allocWithZone:zone];
 
-#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) 
+#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) || (__GNU_LIBOBJC__ >= 20100911)
   if (class_getInstanceSize([fault class]) < class_getInstanceSize([self class])) {
 #else
   if ([fault class]->instance_size < ((Class)(self))->instance_size) {
@@ -143,7 +143,7 @@ typedef struct {
                     @"Instances from class %s must be at least %d "
                     @"in size to fault",
                     NSStringFromClass([fault class]),
-#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) 
+#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) || (__GNU_LIBOBJC__ >= 20100911)
                     class_getInstanceSize([self class])];
 #else
 					((Class)self)->instance_size];
diff --git a/sope-gdl1/GDLAccess/EOFault.m b/sope-gdl1/GDLAccess/EOFault.m
index ae4d86a..2aee02e 100644
--- a/sope-gdl1/GDLAccess/EOFault.m
+++ b/sope-gdl1/GDLAccess/EOFault.m
@@ -38,7 +38,7 @@ typedef struct {
     Class isa;
 } *my_objc_object;
 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 #  warning TODO: implement for NeXT/Apple runtime!
 #  define object_is_instance(object) (object!=nil?YES:NO)
 #  define class_get_super_class class_getSuperclass
@@ -51,7 +51,7 @@ typedef struct objc_method      *Method_t;
       ((object!=nil)&&CLS_ISCLASS(((my_objc_object)object)->isa))
 #endif
 
-#if __GNU_LIBOBJC__ == 20100911
+#if __GNU_LIBOBJC__ >= 20100911
 #  define METHOD_NULL NULL
 #  define class_get_super_class class_getSuperclass
 #  define object_is_instance(object) (object!=nil?YES:NO)
@@ -111,7 +111,7 @@ typedef struct objc_method      *Method_t;
   if (fault == nil) return NO;
   if (EOFaultClass == Nil) EOFaultClass = [EOFault class];
 
-#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__) || (__GNU_LIBOBJC__ >= 20100911)
   for (clazz = ((EOFault *)fault)->isa; clazz; clazz = class_getSuperclass(clazz)) {
 #else
   for (clazz = ((EOFault *)fault)->isa; clazz; clazz = clazz->super_class) {
diff --git a/sope-gdl1/GDLAccess/EOFaultHandler.m b/sope-gdl1/GDLAccess/EOFaultHandler.m
index e9155af..dfdb942 100644
--- a/sope-gdl1/GDLAccess/EOFaultHandler.m
+++ b/sope-gdl1/GDLAccess/EOFaultHandler.m
@@ -29,7 +29,7 @@
 #include "EOFault.h"
 #include "common.h"
 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 #  define METHOD_NULL NULL
 #  define class_get_super_class class_getSuperclass
 #  define object_is_instance(object) (object!=nil?YES:NO)
@@ -47,6 +47,9 @@ typedef struct objc_method      *Method_t;
 #  define class_get_instance_method class_getInstanceMethod
 #endif
 
+#if !(__GNU_LIBOBJC__ >= 20100911)
+#  define sel_getTypeEncoding(selector) ((selector)->sel_types)
+#endif
 
 @implementation EOFaultHandler
 
@@ -114,7 +117,7 @@ typedef struct objc_method      *Method_t;
 - (BOOL)conformsToProtocol:(Protocol *)_protocol forFault:(EOFault *)_fault {
   Class class, sClass;
 
-#if GNU_RUNTIME && !defined(__GNUSTEP_RUNTIME__) && __GNU_LIBOBJC__ != 20100911
+#if GNU_RUNTIME && !defined(__GNUSTEP_RUNTIME__) && !(__GNU_LIBOBJC__ >= 20100911)
   struct objc_protocol_list* protos;
   int i;
   
@@ -181,7 +184,7 @@ typedef struct objc_method      *Method_t;
 
   /* first check for EOFault's own methods */
 
-#if __GNU_LIBOBJC__ != 20100911
+#if !(__GNU_LIBOBJC__ >= 20100911)
   if (types == NULL) {
     // lookup method for selector
     struct objc_method *mth;
@@ -202,7 +205,7 @@ typedef struct objc_method      *Method_t;
 #if GNU_RUNTIME
   // GNU runtime selectors may be typed, a lookup may not be necessary
   if (types == NULL)
-    types = _selector->sel_types;
+    types = sel_getTypeEncoding(_selector);
 #endif
   if (types == NULL)
     return nil;
diff --git a/sope-gdl1/GDLAccess/EOKeyComparisonQualifier+SQL.m b/sope-gdl1/GDLAccess/EOKeyComparisonQualifier+SQL.m
index 8b56c89..e2c85db 100644
--- a/sope-gdl1/GDLAccess/EOKeyComparisonQualifier+SQL.m
+++ b/sope-gdl1/GDLAccess/EOKeyComparisonQualifier+SQL.m
@@ -28,12 +28,6 @@
 #import "EOSQLQualifier.h"
 #include "common.h"
 
-#if NeXT_RUNTIME || APPLE_RUNTIME
-#  ifndef SEL_EQ
-#    define SEL_EQ(__A__,__B__) (__A__==__B__?YES:NO)
-#  endif
-#endif
-
 @implementation EOKeyComparisonQualifier(SQLQualifier)
 
 /* SQL qualifier generation */
diff --git a/sope-gdl1/GDLAccess/EORecordDictionary.m b/sope-gdl1/GDLAccess/EORecordDictionary.m
index 70e55d6..52a693f 100644
--- a/sope-gdl1/GDLAccess/EORecordDictionary.m
+++ b/sope-gdl1/GDLAccess/EORecordDictionary.m
@@ -39,7 +39,7 @@
 #  include <NGExtensions/NGObjectMacros.h>
 #endif
 
-#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ == 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
+#if (defined(__GNU_LIBOBJC__) && (__GNU_LIBOBJC__ >= 20100911)) || defined(APPLE_RUNTIME) || defined(__GNUSTEP_RUNTIME__)
 #  include <objc/runtime.h>
 #  define method_get_imp method_getImplementation
 #  define class_get_instance_method class_getInstanceMethod
diff --git a/sope-gdl1/GDLAccess/common.h b/sope-gdl1/GDLAccess/common.h
index cf9a22f..82965c4 100644
--- a/sope-gdl1/GDLAccess/common.h
+++ b/sope-gdl1/GDLAccess/common.h
@@ -50,6 +50,16 @@
 
 #if NeXT_RUNTIME || APPLE_RUNTIME
 #  define sel_eq(sela,selb) (sela==selb?YES:NO)
+#  ifndef SEL_EQ
+#    define SEL_EQ(__A__,__B__) (__A__==__B__?YES:NO)
+#  endif
+#endif
+
+#if __GNU_LIBOBJC__ >= 20100911
+#  define sel_eq(__A__,__B__) sel_isEqual(__A__,__B__)
+#  ifndef SEL_EQ
+#    define SEL_EQ(__A__,__B__) sel_isEqual(__A__,__B__)
+#  endif
 #endif
 
 #if LIB_FOUNDATION_LIBRARY
diff --git a/sope-ldap/NGLdap/EOQualifier+LDAP.m b/sope-ldap/NGLdap/EOQualifier+LDAP.m
index 8bdadda..cdf8b97 100644
--- a/sope-ldap/NGLdap/EOQualifier+LDAP.m
+++ b/sope-ldap/NGLdap/EOQualifier+LDAP.m
@@ -26,6 +26,10 @@
 #define sel_eq(sel1, sel2) ((sel1)) == ((sel2))
 #endif
 
+#if __GNU_LIBOBJC__ >= 20100911
+#  define sel_eq(__A__,__B__) sel_isEqual(__A__,__B__)
+#endif
+
 @interface EOQualifier(LDAPPrivates)
 
 - (void)addToLDAPFilterString:(NSMutableString *)_s inContext:(id)_ctx;
diff --git a/sope-mime/NGImap4/imCommon.h b/sope-mime/NGImap4/imCommon.h
index 15e6fd7..cbd228a 100644
--- a/sope-mime/NGImap4/imCommon.h
+++ b/sope-mime/NGImap4/imCommon.h
@@ -43,6 +43,12 @@
 #  endif
 #endif
 
+#if __GNU_LIBOBJC__ >= 20100911
+#  ifndef sel_eq
+#    define sel_eq(__A__,__B__) sel_isEqual(__A__,__B__)
+#  endif
+#endif
+
 @interface NSObject(NGImap4_OSXHacks)
 - (void)subclassResponsibility:(SEL)_acmd;
 - (void)notImplemented:(SEL)_acmd;
